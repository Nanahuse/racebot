name: Build and Push Runtime Image

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Set repo owner lowercase
        id: repo
        run: echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Get date tag with increment
        id: datetag
        run: |
          DATE=$(date +'%Y%m%d')
          REPO=ghcr.io/${OWNER}/racebot
          n=0
          while docker manifest inspect "$REPO:$DATE".$n > /dev/null 2>&1; do
            n=$((n+1))
          done
          TAG="${DATE}.$n"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Tag to use: $TAG"

          
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build runtime image
        run: |
          docker build --target runtime -t ghcr.io/${OWNER}/racebot:${TAG} .
          docker tag ghcr.io/${OWNER}/racebot:${TAG} ghcr.io/${OWNER}/racebot:latest

      - name: Push runtime image (latest)
        run: |
          docker push ghcr.io/${OWNER}/racebot:${TAG}
          docker push ghcr.io/${OWNER}/racebot:latest
